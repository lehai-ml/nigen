
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>nimagen.stats &#8212; NIMAGEN 0.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for nimagen.stats</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">stats.py</span>
<span class="sd">Uses to perform mass univariate and everything related to it</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">ttest_ind</span><span class="p">,</span> <span class="n">zscore</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">LabelBinarizer</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">import</span> <span class="nn">tqdm</span>
<span class="kn">from</span> <span class="nn">statsmodels.multivariate.cancorr</span> <span class="kn">import</span> <span class="n">CanCorr</span>

<span class="kn">from</span> <span class="nn">numpy.core._exceptions</span> <span class="kn">import</span> <span class="n">UFuncTypeError</span>


<div class="viewcode-block" id="MassUnivariate"><a class="viewcode-back" href="../../nimagen.html#nimagen.stats.MassUnivariate">[docs]</a><span class="k">class</span> <span class="nc">MassUnivariate</span><span class="p">:</span>
    
<div class="viewcode-block" id="MassUnivariate.prepare_data"><a class="viewcode-back" href="../../nimagen.html#nimagen.stats.MassUnivariate.prepare_data">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">cat_independentVar_cols</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                                    <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                                    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                                                    <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">cont_independentVar_cols</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                                    <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                                    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                                                    <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">dependentVar_cols</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                                    <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                                    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                                                    <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">scaling</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
                    <span class="n">col_to_drop</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        prepare the dependent and independent variables.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df (Optional[pd.DataFrame]): [pandas data frame, where each row is one observation]</span>
<span class="sd">        cat_independentVar_cols (Optional[Union[List[str], List[np.ndarray]]], optional): [list of categorical variables, such that they will be converted to dummies by pandas]. Defaults to None.</span>
<span class="sd">        cont_independentVar_cols (Optional[Union[List[str], List[np.ndarray]]], optional): [list of continuous variables, they will be appended to cat_independentVar_cols]. Defaults to None.</span>
<span class="sd">        dependentVar_cols (Optional[Union[List[str], List[np.ndarray]]], optional): [the dependent variable, the ]. Defaults to None.</span>
<span class="sd">        scaling [str]: Default = both. (&#39;x&#39;,&#39;y&#39;,&#39;both&#39;,&#39;none&#39;)</span>
<span class="sd">        If none, we will not perform standard scaler, &#39;both&#39; we will perform on both x (independent variable- feature) and y (dependent variable- target)</span>
<span class="sd">        col_to_drop [list[str]] = if we want to remove any column from the independent Variable before fitting the model.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            cat independentVar and cont independentVar needs to be list of strings, not list of list.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dependentvar and independentvar pd.DataFrames.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cat_independentVar</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">cont_independentVar</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">dependentVar</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">independentVar</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cat_independentVar_cols</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cat_independentVar_cols</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span> <span class="c1"># if it is just string, put it into list</span>
                <span class="n">cat_independentVar_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">cat_independentVar_cols</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cat_independentVar_col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cat_independentVar_cols</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cat_independentVar_col</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                    <span class="n">cat_independentVar_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">new_df</span><span class="p">[</span><span class="n">cat_independentVar_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                            <span class="n">prefix</span><span class="o">=</span><span class="n">cat_independentVar_col</span><span class="p">,</span>
                                                            <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
                    <span class="n">cat_independentVar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cat_independentVar_temp</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;We need list of string, not list of list&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cat_independentVar_cols</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cat_independentVar_cols</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cat_independentVar_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">cat_independentVar_cols</span><span class="p">,</span>
                                                        <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;Cat_&#39;</span><span class="p">,</span>
                                                        <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
                <span class="n">cat_independentVar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cat_independentVar_temp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cat_independentVar_cols</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">cat_independentVar_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">cat_independentVar_cols</span><span class="p">[:,</span> <span class="n">col</span><span class="p">],</span>
                                                            <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;Cat_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="p">,</span>
                                                            <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
                    <span class="n">cat_independentVar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cat_independentVar_temp</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cat_independentVar_cols</span><span class="p">,(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cat_independentVar_cols</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span> <span class="c1"># only 1 column</span>
                <span class="n">cat_independentVar_cols</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cat_independentVar_cols</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cat_independentVar_cols</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">cat_independentVar_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">cat_independentVar_cols</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                        <span class="n">prefix</span><span class="o">=</span><span class="n">cat_independentVar_cols</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                        <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>

                <span class="n">cat_independentVar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cat_independentVar_temp</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cont_independentVar_cols</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cont_independentVar_cols</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="n">cont_independentVar_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">cont_independentVar_cols</span><span class="p">]</span>

            <span class="n">cont_independentVar_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                <span class="n">new_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cont_independentVar_cols</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">cont_independentVar_temp</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cont_independentVar_temp</span> <span class="o">=</span> <span class="n">cont_independentVar</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scaling</span><span class="o">==</span><span class="s1">&#39;both&#39;</span> <span class="ow">or</span> <span class="n">scaling</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                <span class="n">cont_independentVar_temp</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">cont_independentVar_temp</span><span class="p">)</span>
            <span class="n">cont_independentVar_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cont_independentVar_temp</span><span class="p">)</span>
            <span class="n">cont_independentVar_temp</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">cont_independentVar_cols</span>
            <span class="n">cont_independentVar</span> <span class="o">=</span> <span class="n">cont_independentVar_temp</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span>
                <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
            
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cont_independentVar_cols</span><span class="p">,(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cont_independentVar_cols</span><span class="p">,(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cont_independentVar_cols</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
                    <span class="n">cont_independentVar_cols</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cont_independentVar_cols</span><span class="p">)</span>
                <span class="n">cont_independentVar_temp</span> <span class="o">=</span> <span class="n">cont_independentVar_cols</span><span class="o">.</span><span class="n">values</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cont_independentVar_temp</span> <span class="o">=</span> <span class="n">cont_independentVar_cols</span>
            <span class="k">if</span> <span class="n">cont_independentVar_temp</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cont_independentVar_temp</span> <span class="o">=</span> <span class="n">cont_independentVar_temp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scaling</span><span class="o">==</span><span class="s1">&#39;both&#39;</span> <span class="ow">or</span> <span class="n">scaling</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                <span class="n">cont_independentVar_temp</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">cont_independentVar_temp</span><span class="p">)</span>
            <span class="n">cont_independentVar_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cont_independentVar_temp</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cont_independentVar_cols</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="n">cont_independentVar_temp</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">cont_independentVar_cols</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cont_independentVar_temp</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s1">&#39;Cont_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cont_independentVar_temp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">cont_independentVar</span> <span class="o">=</span> <span class="n">cont_independentVar_temp</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dependentVar_cols</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dependentVar_cols</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="n">dependentVar_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">dependentVar_cols</span><span class="p">]</span>
            
            <span class="n">dependentVar_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">new_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">dependentVar_cols</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">dependentVar_temp</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">dependentVar_temp</span> <span class="o">=</span> <span class="n">dependentVar_temp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scaling</span><span class="o">==</span><span class="s1">&#39;both&#39;</span> <span class="ow">or</span> <span class="n">scaling</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="n">dependentVar_temp</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">dependentVar_temp</span><span class="p">)</span>
            <span class="n">dependentVar_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dependentVar_temp</span><span class="p">)</span>
            <span class="n">dependentVar_temp</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">dependentVar_cols</span>
            <span class="n">dependentVar</span> <span class="o">=</span> <span class="n">dependentVar_temp</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
            
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dependentVar_cols</span><span class="p">,(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dependentVar_cols</span><span class="p">,(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dependentVar_cols</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
                    <span class="n">dependentVar_cols</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dependentVar_cols</span><span class="p">)</span>
                <span class="n">dependentVar_temp</span> <span class="o">=</span>  <span class="n">dependentVar_cols</span><span class="o">.</span><span class="n">values</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dependentVar_temp</span> <span class="o">=</span> <span class="n">dependentVar_cols</span>
            <span class="k">if</span> <span class="n">dependentVar_temp</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">dependentVar_temp</span> <span class="o">=</span> <span class="n">dependentVar_temp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scaling</span><span class="o">==</span><span class="s1">&#39;both&#39;</span> <span class="ow">or</span> <span class="n">scaling</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="n">dependentVar_temp</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">dependentVar_temp</span><span class="p">)</span>
            <span class="n">dependentVar_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dependentVar_temp</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dependentVar_cols</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="n">dependentVar_temp</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">dependentVar_cols</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dependentVar_temp</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s1">&#39;Dependent_Var_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dependentVar_temp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">dependentVar</span> <span class="o">=</span> <span class="n">dependentVar_temp</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
        
        <span class="n">independentVar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cont_independentVar</span><span class="p">)</span>
        <span class="n">independentVar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cat_independentVar</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">independentVar</span><span class="p">:</span>
            <span class="n">independentVar</span><span class="p">[</span><span class="s1">&#39;const&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dependentVar</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]))]</span>
            <span class="n">independentVar</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">independentVar</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">independentVar</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">independentVar</span><span class="p">)</span>
            <span class="n">independentVar</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">independentVar</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">col_to_drop</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">independentVar</span> <span class="o">=</span> <span class="n">independentVar</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">col_to_drop</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c1"># print(&#39;You might be trying to remove the categorical data, which in this function is written as Gender_2.0 or sth.&#39;)</span>
                <span class="n">independentVar</span> <span class="o">=</span> <span class="n">independentVar</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">col_to_drop</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">independentVar</span><span class="o">.</span><span class="n">columns</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dependentVar</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dependentVar</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">dependentVar</span><span class="p">,</span><span class="n">independentVar</span></div>

    
<div class="viewcode-block" id="MassUnivariate.mass_univariate"><a class="viewcode-back" href="../../nimagen.html#nimagen.stats.MassUnivariate.mass_univariate">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">mass_univariate</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">cat_independentVar_cols</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                                        <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                                        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                                                        <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">cont_independentVar_cols</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                                        <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                                        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                                                        <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">dependentVar_cols</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                                        <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                                        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                                                        <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">scaling</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
                        <span class="n">col_to_drop</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">additional_info</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">sm</span><span class="o">.</span><span class="n">regression</span><span class="o">.</span><span class="n">linear_model</span><span class="o">.</span><span class="n">RegressionResultsWrapper</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;[Returns the model and model summary</span>
<span class="sd">            Performs univariate test, implements statsmodel.api.OLS]</span>

<span class="sd">        Args:</span>
<span class="sd">            df (Optional[pd.DataFrame]): [pandas data frame, where each row is one observation]</span>
<span class="sd">            cat_independentVar_cols (Optional[Union[List[str], List[np.ndarray]]], optional): [list of categorical variables, such that they will be converted to dummies by pandas]. Defaults to None.</span>
<span class="sd">            cont_independentVar_cols (Optional[Union[List[str], List[np.ndarray]]], optional): [list of continuous variables, they will be appended to cat_independentVar_cols]. Defaults to None.</span>
<span class="sd">            dependentVar_cols (Optional[Union[List[str], List[np.ndarray]]], optional): [the dependent variable, the ]. Defaults to None.</span>
<span class="sd">            scaling [str]: Default = both. (&#39;x&#39;,&#39;y&#39;,&#39;both&#39;,&#39;none&#39;)</span>
<span class="sd">            If none, we will not perform standard scaler, &#39;both&#39; we will perform on both x (independent variable- feature) and y (dependent variable- target)</span>
<span class="sd">            col_to_drop [list[str]] = if we want to remove any column from the independent Variable before fitting the model.</span>
<span class="sd">            additional_info ([type], optional): [additional columns to be appended]. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[sm.regression.linear_model.RegressionResultsWrapper, pd.DataFrame]: [the statsmodel model and dataframe of the model summary, where cols are independent variables and const]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model_summary</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        
        <span class="n">dependentVar</span><span class="p">,</span> <span class="n">independentVar</span> <span class="o">=</span> <span class="n">MassUnivariate</span><span class="o">.</span><span class="n">prepare_data</span><span class="p">(</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">,</span>
                                    <span class="n">cat_independentVar_cols</span><span class="o">=</span><span class="n">cat_independentVar_cols</span><span class="p">,</span>
                                    <span class="n">cont_independentVar_cols</span><span class="o">=</span><span class="n">cont_independentVar_cols</span><span class="p">,</span>
                                    <span class="n">dependentVar_cols</span><span class="o">=</span><span class="n">dependentVar_cols</span><span class="p">,</span>
                                    <span class="n">scaling</span><span class="o">=</span><span class="n">scaling</span><span class="p">,</span>
                                    <span class="n">col_to_drop</span><span class="o">=</span><span class="n">col_to_drop</span><span class="p">)</span>

        
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">dependentVar</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">last_model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">dependentVar</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">feature</span><span class="p">],</span> <span class="n">independentVar</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">last_model</span><span class="o">.</span><span class="n">params</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">last_model</span><span class="o">.</span><span class="n">pvalues</span><span class="p">))</span>
            <span class="n">result</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_model</span><span class="o">.</span><span class="n">params</span>
            <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_model</span><span class="o">.</span><span class="n">pvalues</span>
            <span class="n">model_summary</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="n">model_summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">model_summary</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">list1</span> <span class="o">=</span> <span class="n">independentVar</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="n">list2</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_coef&#39;</span><span class="p">,</span> <span class="s1">&#39;_pval&#39;</span><span class="p">]</span>

        <span class="n">model_summary</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">n</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">list1</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">list2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">additional_info</span><span class="p">:</span>
            <span class="n">model_summary</span><span class="p">[</span><span class="s1">&#39;Additional_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">additional_info</span>
            <span class="n">model_summary</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">n</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">list1</span>
                                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">list2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Additional_info&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">last_model</span><span class="p">,</span> <span class="n">model_summary</span></div>
    
<div class="viewcode-block" id="MassUnivariate.remove_outliers"><a class="viewcode-back" href="../../nimagen.html#nimagen.stats.MassUnivariate.remove_outliers">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">remove_outliers</span><span class="p">(</span><span class="n">df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                        <span class="n">col</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">List</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">threshold</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">remove_schemes</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;any&#39;</span><span class="p">,</span>
                        <span class="n">percentage_of_outlier</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                        <span class="n">subject_ID</span><span class="p">:</span><span class="nb">list</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;[Remove outliers using the z-score (the same as using StandardScaler). The standard deviation]</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pd.DataFrame): [Dataframe of interest]</span>
<span class="sd">            col (str or List, optional): [column of interest]. Defaults to None.</span>
<span class="sd">            threshold (float, optional): [the threshold of the z-score]. Defaults to None.</span>
<span class="sd">            subject_ID (list, optional): [Or gives me the list of subject IDs and remove by that way]. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: [New data frame without the outliers]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">idx_to_remove_by_col</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">idx_to_remove_by_ID</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">remove_schemes</span> <span class="o">==</span> <span class="s1">&#39;any&#39;</span><span class="p">:</span> <span class="c1">#remove observations that have outlier in any of the examined column</span>
                <span class="n">idx_to_remove_by_col</span> <span class="o">=</span> <span class="n">new_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">zscore</span><span class="p">(</span><span class="n">new_df</span><span class="p">[</span><span class="n">col</span><span class="p">]))</span><span class="o">&gt;</span><span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">remove_schemes</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span> <span class="c1">#remove observations that have outlier in all of the examined column</span>
                <span class="n">idx_to_remove_by_col</span> <span class="o">=</span> <span class="n">new_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">zscore</span><span class="p">(</span><span class="n">new_df</span><span class="p">[</span><span class="n">col</span><span class="p">]))</span><span class="o">&gt;</span><span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">remove_schemes</span> <span class="o">==</span> <span class="s1">&#39;sum&#39;</span><span class="p">:</span> <span class="c1"># sum up the cols of interests and remove the outlier based on that sum</span>
                <span class="n">idx_to_remove_by_col</span> <span class="o">=</span> <span class="n">new_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">zscore</span><span class="p">(</span><span class="n">new_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span><span class="o">&gt;</span><span class="n">threshold</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">remove_schemes</span> <span class="o">==</span> <span class="s1">&#39;percentage&#39;</span><span class="p">:</span> <span class="c1"># remove observations that have more than x% of all features are outliers</span>
                <span class="n">all_zscores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">zscore</span><span class="p">(</span><span class="n">new_df</span><span class="p">[</span><span class="n">col</span><span class="p">]))</span>
                <span class="n">idx_to_remove_by_col</span> <span class="o">=</span> <span class="n">new_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">all_zscores</span><span class="o">&gt;</span><span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;=</span><span class="n">percentage_of_outlier</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">subject_ID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">idx_to_remove_by_ID</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_df</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">subject_ID</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
        <span class="n">idx_to_remove</span> <span class="o">=</span> <span class="n">idx_to_remove_by_col</span> <span class="o">+</span> <span class="n">idx_to_remove_by_ID</span>
        <span class="n">idx_to_remove</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">idx_to_remove</span><span class="p">))</span>
        <span class="n">new_df</span> <span class="o">=</span> <span class="n">new_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">idx_to_remove</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_df</span></div>

<div class="viewcode-block" id="MassUnivariate.adjust_covariates_with_lin_reg"><a class="viewcode-back" href="../../nimagen.html#nimagen.stats.MassUnivariate.adjust_covariates_with_lin_reg">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">adjust_covariates_with_lin_reg</span><span class="p">(</span><span class="n">df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                       <span class="n">cat_independentVar_cols</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                                                      <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                                                      <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                                                                      <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                       <span class="n">cont_independentVar_cols</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                                                       <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                                                       <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                                                                       <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                       <span class="n">dependentVar_cols</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                                                <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                                                <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                                                                <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                      <span class="n">return_model_adjuster</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                       <span class="o">**</span><span class="n">massunivariatekwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adjusting covariates by using linear regression</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : pd.DataFrame, optional</span>
<span class="sd">            The dataframe if providing strings as covariates. The default is None.</span>
<span class="sd">        cat_independentVar_cols : Union[List[str],np.ndarray,pd.DataFrame,pd.Series], optional</span>
<span class="sd">            The categorical variables. The default is None.</span>
<span class="sd">        cont_independentVar_cols : Union[List[str],np.ndarray,pd.DataFrame,pd.Series], optional</span>
<span class="sd">            The continuous variables. The default is None.</span>
<span class="sd">        dependentVar_cols : Union[List[str],np.ndarray,pd.DataFrame,pd.Series], optional</span>
<span class="sd">            The variables needed to be adjusted. The default is None.</span>
<span class="sd">        return_model_adjuster:bool</span>
<span class="sd">            Return a dictionary of linear models used to fit.</span>
<span class="sd">        *massunivariatekwargs : dict</span>
<span class="sd">            Anything from the MassUnivariate.mass_univariate function.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            The dataframe of the adjusted variables, the columns will be the same as the one provided. The index will be the same as the df if provided.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">adjusted_X</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">model_list</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dependentVar_cols</span><span class="p">,(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dependentVar_cols</span><span class="p">,(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dependentVar_cols</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
                    <span class="n">dependentVar_cols</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dependentVar_cols</span><span class="p">)</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">dependentVar_cols</span><span class="o">.</span><span class="n">values</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">dependentVar_cols</span>
            <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">model</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">MassUnivariate</span><span class="o">.</span><span class="n">mass_univariate</span><span class="p">(</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">,</span>
                                                         <span class="n">cat_independentVar_cols</span><span class="o">=</span><span class="n">cat_independentVar_cols</span><span class="p">,</span>
                                                         <span class="n">cont_independentVar_cols</span><span class="o">=</span><span class="n">cont_independentVar_cols</span><span class="p">,</span>
                                                         <span class="n">dependentVar_cols</span><span class="o">=</span><span class="n">X</span><span class="p">[:,</span><span class="n">idx</span><span class="p">],</span><span class="o">**</span><span class="n">massunivariatekwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dependentVar_cols</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                    <span class="n">adjusted_X</span><span class="p">[</span><span class="n">dependentVar_cols</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">idx</span><span class="p">]]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">resid</span><span class="o">.</span><span class="n">values</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">adjusted_X</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">resid</span><span class="o">.</span><span class="n">values</span>
                <span class="k">if</span> <span class="n">return_model_adjuster</span><span class="p">:</span>
                    <span class="n">model_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dependentVar_cols</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dependentVar_cols</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="n">dependentVar_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">dependentVar_cols</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">dependentVar_col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dependentVar_cols</span><span class="p">):</span>
                <span class="n">model</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">MassUnivariate</span><span class="o">.</span><span class="n">mass_univariate</span><span class="p">(</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">,</span>
                                                         <span class="n">cat_independentVar_cols</span><span class="o">=</span><span class="n">cat_independentVar_cols</span><span class="p">,</span>
                                                         <span class="n">cont_independentVar_cols</span><span class="o">=</span><span class="n">cont_independentVar_cols</span><span class="p">,</span>
                                                         <span class="n">dependentVar_cols</span><span class="o">=</span><span class="n">dependentVar_col</span><span class="p">,</span><span class="o">**</span><span class="n">massunivariatekwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dependentVar_col</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                    <span class="n">adjusted_X</span><span class="p">[</span><span class="n">dependentVar_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">resid</span><span class="o">.</span><span class="n">values</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">adjusted_X</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">resid</span><span class="o">.</span><span class="n">values</span>
                <span class="k">if</span> <span class="n">return_model_adjuster</span><span class="p">:</span>
                    <span class="n">model_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">adjusted_X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">adjusted_X</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">adjusted_X</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
        <span class="k">if</span> <span class="n">return_model_adjuster</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">adjusted_X</span><span class="p">,</span> <span class="n">model_list</span>
        <span class="k">return</span> <span class="n">adjusted_X</span></div>
        
<div class="viewcode-block" id="MassUnivariate.calculate_mass_univariate_across_multiple_thresholds"><a class="viewcode-back" href="../../nimagen.html#nimagen.stats.MassUnivariate.calculate_mass_univariate_across_multiple_thresholds">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">calculate_mass_univariate_across_multiple_thresholds</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span>
            <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
            <span class="n">thresholds</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
            <span class="n">cat_independentVar_cols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                            <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">cont_independentVar_cols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                                    <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">dependentVar_cols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                            <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : pd.DataFrame</span>
<span class="sd">            the dataframe.</span>
<span class="sd">        thresholds : List[str]</span>
<span class="sd">            DESCRIPTION.</span>
<span class="sd">        see MassUnivariate.mass_univariate for full variable descriptions</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        new_df : TYPE</span>
<span class="sd">            DESCRIPTION.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cont_independentVar_cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cont_independentVar_cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">threshold</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">thresholds</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">temp_model_summary</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mass_univariate</span><span class="p">(</span>
                    <span class="n">df</span><span class="p">,</span>
                    <span class="n">cat_independentVar_cols</span><span class="o">=</span><span class="n">cat_independentVar_cols</span><span class="p">,</span>
                    <span class="n">cont_independentVar_cols</span><span class="o">=</span><span class="n">cont_independentVar_cols</span> <span class="o">+</span> <span class="p">[</span><span class="n">threshold</span><span class="p">],</span>
                    <span class="n">dependentVar_cols</span><span class="o">=</span><span class="n">dependentVar_cols</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">temp_model_summary</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">temp_model_summary</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;Connection&#39;</span><span class="p">,</span>
                        <span class="n">threshold</span> <span class="o">+</span> <span class="s1">&#39;_coef&#39;</span><span class="p">:</span> <span class="s1">&#39;PRS_coef&#39;</span><span class="p">,</span>
                        <span class="n">threshold</span> <span class="o">+</span> <span class="s1">&#39;_pval&#39;</span><span class="p">:</span> <span class="s1">&#39;PRS_pval&#39;</span>
                    <span class="p">},</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">UFuncTypeError</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cont_independentVar_cols</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="n">threshold_array</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">threshold</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">updated_cont_independentVar_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">cont_independentVar_cols</span><span class="p">,</span><span class="n">threshold_array</span><span class="p">])</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">temp_model_summary</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mass_univariate</span><span class="p">(</span>
                        <span class="n">df</span><span class="p">,</span>
                        <span class="n">cat_independentVar_cols</span><span class="o">=</span><span class="n">cat_independentVar_cols</span><span class="p">,</span>
                        <span class="n">cont_independentVar_cols</span><span class="o">=</span><span class="n">updated_cont_independentVar_cols</span><span class="p">,</span>
                        <span class="n">dependentVar_cols</span><span class="o">=</span><span class="n">dependentVar_cols</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">threshold_idx</span> <span class="o">=</span> <span class="n">updated_cont_independentVar_cols</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
                <span class="n">temp_model_summary</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">temp_model_summary</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;Connection&#39;</span><span class="p">,</span>
                        <span class="n">threshold</span> <span class="o">+</span> <span class="s1">&#39;_coef&#39;</span><span class="p">:</span> <span class="s1">&#39;PRS_coef&#39;</span><span class="p">,</span>
                        <span class="n">threshold</span> <span class="o">+</span> <span class="s1">&#39;_pval&#39;</span><span class="p">:</span> <span class="s1">&#39;PRS_pval&#39;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s1">&#39;Cont_</span><span class="si">{</span><span class="n">threshold_idx</span><span class="si">}</span><span class="s1">_coef&#39;</span><span class="p">:</span><span class="s1">&#39;PRS_coef&#39;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s1">&#39;Cont_</span><span class="si">{</span><span class="n">threshold_idx</span><span class="si">}</span><span class="s1">_pval&#39;</span><span class="p">:</span><span class="s1">&#39;PRS_pval&#39;</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">temp_model_summary</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">threshold</span>
            <span class="n">new_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">new_df</span><span class="p">,</span><span class="n">temp_model_summary</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
        <span class="n">new_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_df</span></div>

<div class="viewcode-block" id="MassUnivariate.calculate_R_squared_explained"><a class="viewcode-back" href="../../nimagen.html#nimagen.stats.MassUnivariate.calculate_R_squared_explained">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">calculate_R_squared_explained</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                                      <span class="n">col_to_drop</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;[Calculate R squared explained from the model]</span>

<span class="sd">        Args:</span>
<span class="sd">            df ([pd.DataFrame]): [the model to be passed to the univariate model]</span>
<span class="sd">            col_to_drop (List[str], optional): [the column names of the data frame to be removed in the univariate model]. Defaults to None.</span>
<span class="sd">            **kwargs:</span>
<span class="sd">            cat_independentVar_cols (Optional[Union[List[str], List[np.ndarray]]], optional): [list of categorical variables, such that they will be converted to dummies by pandas]. Defaults to None.</span>
<span class="sd">            cont_independentVar_cols (Optional[Union[List[str], List[np.ndarray]]], optional): [list of continuous variables, they will be appended to cat_independentVar_cols]. Defaults to None.</span>
<span class="sd">            dependentVar_cols (Optional[Union[List[str], List[np.ndarray]]], optional): [the dependent variable, the ]. Defaults to None.</span>
<span class="sd">            scaling [str]: Default = both. (&#39;x&#39;,&#39;y&#39;,&#39;both&#39;,&#39;none&#39;)</span>
<span class="sd">            If none, we will not perform standard scaler, &#39;both&#39; we will perform on both x (independent variable- feature) and y (dependent variable- target)            col_to_drop [list[str]] = if we want to remove any column from the independent Variable before fitting the model.</span>
<span class="sd">            additional_info ([type], optional): [additional columns to be appended]. Defaults to None.</span>
<span class="sd">        Returns:</span>
<span class="sd">            [float]: [difference in the full and the null model R squared]</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">full_model</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mass_univariate</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">col_to_drop</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">full_model</span><span class="o">.</span><span class="n">rsquared</span>
        <span class="n">null_model</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mass_univariate</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">col_to_drop</span><span class="o">=</span><span class="n">col_to_drop</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">full_model</span><span class="o">.</span><span class="n">rsquared</span> <span class="o">-</span> <span class="n">null_model</span><span class="o">.</span><span class="n">rsquared</span></div>
    
<div class="viewcode-block" id="MassUnivariate.get_model_summary"><a class="viewcode-back" href="../../nimagen.html#nimagen.stats.MassUnivariate.get_model_summary">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_model_summary</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                              <span class="n">cat_independentVar_cols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">cont_independentVar_cols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">dependentVar_cols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print model summary with Beta coefficient, Pvalues and R squared for an individual statsmodel</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        *same arguments as MassUnivariate.mass_univariate</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        result_df : pd.DataFrame</span>
<span class="sd">            DataFrame, index = independent Variable, columns = beta, p-value and Rsquared (fullmodel - null model)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#print model summary with beta, p-value and R2</span>
        <span class="n">result_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cat_independentVar_cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cat_independentVar_cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">cont_independentVar_cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cont_independentVar_cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">full_model</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mass_univariate</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">cat_independentVar_cols</span><span class="o">=</span><span class="n">cat_independentVar_cols</span><span class="p">,</span>
                                            <span class="n">cont_independentVar_cols</span><span class="o">=</span><span class="n">cont_independentVar_cols</span><span class="p">,</span>
                                            <span class="n">dependentVar_cols</span> <span class="o">=</span> <span class="n">dependentVar_cols</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">result_dict</span><span class="p">[</span><span class="s1">&#39;beta_coefs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">result_dict</span><span class="p">[</span><span class="s1">&#39;pvalues&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_model</span><span class="o">.</span><span class="n">pvalues</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">full_model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
            <span class="n">result_dict</span><span class="p">[</span><span class="s1">&#39;Rsquared&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">calculate_R_squared_explained</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">col_to_drop</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span>
                                                                             <span class="n">cat_independentVar_cols</span><span class="o">=</span><span class="n">cat_independentVar_cols</span><span class="p">,</span>
                                                                             <span class="n">cont_independentVar_cols</span><span class="o">=</span><span class="n">cont_independentVar_cols</span><span class="p">,</span>
                                                                             <span class="n">dependentVar_cols</span> <span class="o">=</span> <span class="n">dependentVar_cols</span><span class="p">))</span>
        <span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result_dict</span><span class="p">,</span><span class="n">index</span> <span class="o">=</span> <span class="n">full_model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result_df</span></div>
    
<div class="viewcode-block" id="MassUnivariate.check_all_predictors_combo_linear_Reg"><a class="viewcode-back" href="../../nimagen.html#nimagen.stats.MassUnivariate.check_all_predictors_combo_linear_Reg">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">check_all_predictors_combo_linear_Reg</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">df</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                            <span class="n">cat_independentVar_cols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                            <span class="n">cont_independentVar_cols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                            <span class="n">check_cols</span><span class="p">:</span><span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                            <span class="n">check_plan</span><span class="p">:</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                            <span class="n">dependentVar_cols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[Perform univariate test on all combinations of predictors]</span>

<span class="sd">        Args:</span>
<span class="sd">            df (Optional[pd.DataFrame]): [description]</span>
<span class="sd">            cat_independentVar_cols (Optional[List[str]], optional): [categorical variable]. Defaults to None.</span>
<span class="sd">            cont_independentVar_cols (Optional[List[str]], optional): [Continuous variables]. Defaults to None.</span>
<span class="sd">            dependentVar_cols (Optional[List[str]], optional): [description]. Defaults to None.</span>
<span class="sd">        Returns:</span>
<span class="sd">            [type]: [description]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_models</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">print_model_results</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">sm</span><span class="o">.</span><span class="n">regression</span><span class="o">.</span><span class="n">linear_model</span><span class="o">.</span><span class="n">RegressionResultsWrapper</span><span class="p">,</span>
                                <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                <span class="n">dictionary</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">all_models</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#convenience function to print the model results from the sm.regression model</span>
            
            <span class="n">variables</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            <span class="n">len_variables</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">coefs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            <span class="n">p_vals</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">pvalues</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            <span class="n">aic</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">aic</span>
            <span class="n">R2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">rsquared</span>
            <span class="n">R2_adj</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">rsquared_adj</span>

            <span class="n">dictionary</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">len_variables</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">coefs</span><span class="p">,</span> <span class="n">p_vals</span><span class="p">,</span> <span class="n">aic</span><span class="p">,</span> <span class="n">R2</span><span class="p">,</span> <span class="n">R2_adj</span><span class="p">])</span>
        
        <span class="n">null_model</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mass_univariate</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                                        <span class="n">cat_independentVar_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                        <span class="n">cont_independentVar_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                        <span class="n">dependentVar_cols</span><span class="o">=</span><span class="n">dependentVar_cols</span><span class="p">)</span>
        <span class="n">print_model_results</span><span class="p">(</span><span class="n">null_model</span><span class="p">,</span> <span class="s1">&#39;0_0&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cat_independentVar_cols</span><span class="p">:</span>
            <span class="n">cat_independentVar_cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cont_independentVar_cols</span><span class="p">:</span>
            <span class="n">cont_independentVar_cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_predictors</span> <span class="o">=</span> <span class="n">cat_independentVar_cols</span> <span class="o">+</span> <span class="n">cont_independentVar_cols</span>
        
        <span class="n">check_all</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_cols</span><span class="p">:</span>
            <span class="n">check_all</span><span class="o">=</span><span class="kc">True</span>
            <span class="n">check_cols</span> <span class="o">=</span> <span class="n">total_predictors</span>
        
        <span class="k">if</span> <span class="n">check_plan</span><span class="o">==</span><span class="s1">&#39;sequential&#39;</span><span class="p">:</span>
            <span class="n">k_combo</span> <span class="o">=</span> <span class="p">(</span><span class="n">check_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">check_cols</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">model_combo</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">k_combo</span><span class="p">)):</span>
                <span class="n">cat_independentVar_cols_temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cat_independentVar_cols</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">check_cols</span><span class="p">]</span>
                <span class="n">cont_independentVar_cols_temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cont_independentVar_cols</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">check_cols</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">covar</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_combo</span><span class="p">):</span>

                    <span class="k">if</span> <span class="n">covar</span> <span class="ow">in</span> <span class="n">cat_independentVar_cols</span><span class="p">:</span>
                        <span class="n">cat_independentVar_cols_temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">covar</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">covar</span> <span class="ow">in</span> <span class="n">cont_independentVar_cols</span><span class="p">:</span>
                        <span class="n">cont_independentVar_cols_temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">covar</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat_independentVar_cols_temp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cat_independentVar_cols_temp</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cont_independentVar_cols_temp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cont_independentVar_cols_temp</span> <span class="o">=</span> <span class="kc">None</span>
                
                <span class="n">model_temp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mass_univariate</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                                                <span class="n">cat_independentVar_cols</span><span class="o">=</span><span class="n">cat_independentVar_cols_temp</span><span class="p">,</span>
                                                <span class="n">cont_independentVar_cols</span><span class="o">=</span><span class="n">cont_independentVar_cols_temp</span><span class="p">,</span>
                                                <span class="n">dependentVar_cols</span><span class="o">=</span><span class="n">dependentVar_cols</span><span class="p">)</span>

                <span class="n">model_name_temp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_combo</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="n">print_model_results</span><span class="p">(</span><span class="n">model_temp</span><span class="p">,</span> <span class="n">model_name_temp</span><span class="p">)</span>
        <span class="c1"># for k in range(1,len(total_predictors)+1):</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_cols</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)):</span>
                <span class="n">k_combo</span> <span class="o">=</span> <span class="n">combinations</span><span class="p">(</span><span class="n">check_cols</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">model_combo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">k_combo</span><span class="p">):</span>
                    <span class="n">cat_independentVar_cols_temp</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">cont_independentVar_cols_temp</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_all</span><span class="p">:</span>
                        <span class="n">cat_independentVar_cols_temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cat_independentVar_cols</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">check_cols</span><span class="p">]</span>
                        <span class="n">cont_independentVar_cols_temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cont_independentVar_cols</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">check_cols</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">covar</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_combo</span><span class="p">):</span>
    
                        <span class="k">if</span> <span class="n">covar</span> <span class="ow">in</span> <span class="n">cat_independentVar_cols</span><span class="p">:</span>
                            <span class="n">cat_independentVar_cols_temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">covar</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">covar</span> <span class="ow">in</span> <span class="n">cont_independentVar_cols</span><span class="p">:</span>
                            <span class="n">cont_independentVar_cols_temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">covar</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat_independentVar_cols_temp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">cat_independentVar_cols_temp</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cont_independentVar_cols_temp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">cont_independentVar_cols_temp</span> <span class="o">=</span> <span class="kc">None</span>
                    
                    <span class="n">model_temp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mass_univariate</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                                                    <span class="n">cat_independentVar_cols</span><span class="o">=</span><span class="n">cat_independentVar_cols_temp</span><span class="p">,</span>
                                                    <span class="n">cont_independentVar_cols</span><span class="o">=</span><span class="n">cont_independentVar_cols_temp</span><span class="p">,</span>
                                                    <span class="n">dependentVar_cols</span><span class="o">=</span><span class="n">dependentVar_cols</span><span class="p">)</span>
    
                    <span class="n">model_name_temp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                    <span class="n">print_model_results</span><span class="p">(</span><span class="n">model_temp</span><span class="p">,</span> <span class="n">model_name_temp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">all_models</span></div>

<div class="viewcode-block" id="MassUnivariate.preprocess_forward_selection"><a class="viewcode-back" href="../../nimagen.html#nimagen.stats.MassUnivariate.preprocess_forward_selection">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">preprocess_forward_selection</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">dictionary</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;[Preprocess the info of mass univariate tests, all possible combo of predictors</span>
<span class="sd">        Input is the output from ```check_all_predictors_combo_linear_Reg```]</span>

<span class="sd">        Args:</span>
<span class="sd">            dictionary (dict): [Output form ```check_all_predictors_combo_linear_Reg```]</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[pd.DataFrame]: [4 data frames - score_summary, variable combo summary, beta coefs, p-values]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">temp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">temp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">temp_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">temp_df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># this will preprocess the dictionary</span>
        <span class="n">temp_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;N_var&#39;</span><span class="p">,</span> <span class="s1">&#39;Var&#39;</span><span class="p">,</span> <span class="s1">&#39;Beta&#39;</span><span class="p">,</span> <span class="s1">&#39;P_val&#39;</span><span class="p">,</span> <span class="s1">&#39;AIC&#39;</span><span class="p">,</span> <span class="s1">&#39;R2&#39;</span><span class="p">,</span> <span class="s1">&#39;R2_adj&#39;</span><span class="p">]</span>
        <span class="n">model_score_summary</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[[</span><span class="s1">&#39;N_var&#39;</span><span class="p">,</span> <span class="s1">&#39;AIC&#39;</span><span class="p">,</span> <span class="s1">&#39;R2&#39;</span><span class="p">,</span> <span class="s1">&#39;R2_adj&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">model_var_summary</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[[</span><span class="s1">&#39;Var&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">all_predictors</span> <span class="o">=</span> <span class="n">model_var_summary</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">label_binarizer</span> <span class="o">=</span> <span class="n">LabelBinarizer</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">all_predictors</span><span class="p">)</span>
        <span class="n">model_var_summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">model_var_summary</span><span class="p">[</span><span class="s1">&#39;Var&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">label_binarizer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))[</span><span class="s1">&#39;Var&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>
        <span class="n">model_var_summary</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">label_binarizer</span><span class="o">.</span><span class="n">classes_</span>
        <span class="n">model_var_summary</span> <span class="o">=</span> <span class="n">model_var_summary</span><span class="p">[</span><span class="n">all_predictors</span><span class="p">]</span>

        <span class="n">model_beta_summary</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="s1">&#39;Beta&#39;</span><span class="p">]</span>
        <span class="n">model_p_summary</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="s1">&#39;P_val&#39;</span><span class="p">]</span>
        <span class="n">model_beta</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">model_p</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_var_summary</span><span class="p">)):</span>
            <span class="n">beta_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">model_beta_summary</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="n">p_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">model_p_summary</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">model_var_summary</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">model_beta</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">beta_iter</span><span class="p">))</span>
                    <span class="n">model_p</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">p_iter</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">model_beta</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">model_p</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">model_beta_summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">model_beta</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">model_p_summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">model_p</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">model_beta_summary</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">model_var_summary</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">model_p_summary</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">model_var_summary</span><span class="o">.</span><span class="n">columns</span>

        <span class="k">return</span> <span class="n">model_score_summary</span><span class="p">,</span> <span class="n">model_var_summary</span><span class="p">,</span> <span class="n">model_beta_summary</span><span class="p">,</span> <span class="n">model_p_summary</span></div>

<div class="viewcode-block" id="MassUnivariate.print_summary_table"><a class="viewcode-back" href="../../nimagen.html#nimagen.stats.MassUnivariate.print_summary_table">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">print_summary_table</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
                            <span class="n">df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                            <span class="n">thresholds</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">cat_independentVar_cols</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">cont_independentVar_cols</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">dependentVar_cols</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        see data_exploration.MassUnivariate.mass_univariate for full description of the variables</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        summary_table : pd.DataFrame</span>
<span class="sd">            The summary table containing R, Beta value, P-value for each dependent variable at each PRS threshold.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Result_dict</span><span class="o">=</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dependent_variable</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">dependentVar_cols</span><span class="p">):</span>
            <span class="n">Result_dict</span><span class="p">[</span><span class="n">dependent_variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">threshold</span> <span class="ow">in</span> <span class="n">thresholds</span><span class="p">:</span>
                <span class="n">Result_dict</span><span class="p">[</span><span class="n">dependent_variable</span><span class="p">][</span><span class="n">threshold</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
                <span class="n">Result_dict</span><span class="p">[</span><span class="n">dependent_variable</span><span class="p">][</span><span class="n">threshold</span><span class="p">][</span><span class="s1">&#39;R2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
                <span class="n">temp_model</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mass_univariate</span><span class="p">(</span>
                    <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                    <span class="n">cat_independentVar_cols</span><span class="o">=</span><span class="n">cat_independentVar_cols</span><span class="p">,</span>
                    <span class="n">cont_independentVar_cols</span><span class="o">=</span><span class="n">cont_independentVar_cols</span> <span class="o">+</span> <span class="p">[</span><span class="n">threshold</span><span class="p">],</span>
                    <span class="n">dependentVar_cols</span><span class="o">=</span><span class="p">[</span><span class="n">dependent_variable</span><span class="p">])</span> <span class="c1"># calculate a full model</span>
                <span class="n">Result_dict</span><span class="p">[</span><span class="n">dependent_variable</span><span class="p">][</span><span class="n">threshold</span><span class="p">][</span><span class="s1">&#39;Beta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
                <span class="n">Result_dict</span><span class="p">[</span><span class="n">dependent_variable</span><span class="p">][</span><span class="n">threshold</span><span class="p">][</span><span class="s1">&#39;P_val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_model</span><span class="o">.</span><span class="n">pvalues</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">col_to_drop</span> <span class="ow">in</span> <span class="n">cont_independentVar_cols</span> <span class="o">+</span> <span class="n">cat_independentVar_cols</span> <span class="o">+</span> <span class="p">[</span><span class="n">threshold</span><span class="p">]:</span>
                    <span class="n">Result_dict</span><span class="p">[</span><span class="n">dependent_variable</span><span class="p">][</span><span class="n">threshold</span><span class="p">][</span><span class="s1">&#39;R2&#39;</span><span class="p">][</span>
                        <span class="n">col_to_drop</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">calculate_R_squared_explained</span><span class="p">(</span>
                            <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                            <span class="n">col_to_drop</span><span class="o">=</span><span class="n">col_to_drop</span><span class="p">,</span>
                            <span class="n">cat_independentVar_cols</span><span class="o">=</span><span class="n">cat_independentVar_cols</span><span class="p">,</span>
                            <span class="n">cont_independentVar_cols</span><span class="o">=</span><span class="n">cont_independentVar_cols</span><span class="p">,</span>
                            <span class="n">dependentVar_cols</span><span class="o">=</span><span class="p">[</span><span class="n">dependent_variable</span><span class="p">])</span>
        
        <span class="n">summary_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">):</span> <span class="n">Result_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> 
                                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Result_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> 
                                                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">Result_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> 
                                                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">Result_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()},</span>
                       <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">summary_table</span></div></div>
        
<div class="viewcode-block" id="matSpDLite"><a class="viewcode-back" href="../../nimagen.html#nimagen.stats.matSpDLite">[docs]</a><span class="k">def</span> <span class="nf">matSpDLite</span><span class="p">(</span><span class="n">correlation_matrix</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="n">alpha</span><span class="p">:</span><span class="nb">str</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adapted from Nyholt DR R script.</span>
<span class="sd">    Please cite</span>
<span class="sd">    Nyholt DR (2004) A simple correction for multiple testing for SNPs in linkage disequilibrium with each other. Am J Hum Genet 74(4):765-769.</span>
<span class="sd">    and </span>
<span class="sd">    http://gump.qimr.edu.au/general/daleN/matSpDlite/</span>
<span class="sd">    and</span>
<span class="sd">    Li and Ji 2005. </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    correlation_matrix : np.ndarray</span>
<span class="sd">        The correlation matrix. It must be symmetric.</span>
<span class="sd">    alpha : str, optional</span>
<span class="sd">        DESCRIPTION. The default is 0.05.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">evals</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">correlation_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">evals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">evals</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">oldV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">evals</span><span class="p">,</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">evals</span><span class="p">)</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">M</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">Meffold</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span> <span class="n">oldV</span><span class="o">/</span><span class="n">M</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Effective Number of Independent Variables [Veff] is </span><span class="si">{</span><span class="n">Meffold</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">newevals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">evals</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">evals</span><span class="p">)</span> <span class="c1"># negative eigenvalues are set to 0</span>
    
    <span class="n">IntLinewevals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">newevals</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#the integral part &quot;represents identical tests that should be counted as one in Meff&quot;</span>
    <span class="n">NonIntLinewevals</span> <span class="o">=</span> <span class="n">newevals</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">newevals</span><span class="p">)</span> <span class="c1"># the non integral part should represent the partially correlated test that should be counted as a fractional number between 0 and 1</span>
    <span class="n">MeffLi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">IntLinewevals</span> <span class="o">+</span> <span class="n">NonIntLinewevals</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Effective Number of Independent Variables [VeffLi] (Using equation 5 of Li and Ji 2005) is </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">MeffLi</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">MeffLi</span> <span class="o">&lt;</span> <span class="n">Meffold</span><span class="p">:</span>
        <span class="n">adjusted_p_val</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">/</span><span class="n">MeffLi</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">adjusted_p_val</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">/</span><span class="n">Meffold</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The adjusted multiple testing correction p-val is alpha/lower(Meff) = </span><span class="si">{</span><span class="n">adjusted_p_val</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">MeffLi</span></div>


<span class="c1"># def save_dict_with_pickle(dictionary: Optional[dict],</span>
<span class="c1">#                           file_path: Optional[str]) -&gt; None:</span>
<span class="c1">#     a_file = open(file_path, &#39;wb&#39;)</span>
<span class="c1">#     pickle.dump(dictionary, a_file)</span>
<span class="c1">#     a_file.close()</span>


<span class="c1"># def open_dict_with_pickle(file_path: Optional[str]) -&gt; dict:</span>
<span class="c1">#     a_file = open(file_path, &#39;rb&#39;)</span>
<span class="c1">#     dictionary = pickle.load(a_file)</span>
<span class="c1">#     return dictionary</span>

<div class="viewcode-block" id="perform_CCA"><a class="viewcode-back" href="../../nimagen.html#nimagen.stats.perform_CCA">[docs]</a><span class="k">def</span> <span class="nf">perform_CCA</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
    
    <span class="n">stats_cca</span> <span class="o">=</span> <span class="n">CanCorr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stats_cca</span><span class="o">.</span><span class="n">corr_test</span><span class="p">()</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span></div>

<div class="viewcode-block" id="Stability_tests"><a class="viewcode-back" href="../../nimagen.html#nimagen.stats.Stability_tests">[docs]</a><span class="k">class</span> <span class="nc">Stability_tests</span><span class="p">:</span>
    
<div class="viewcode-block" id="Stability_tests.train_test_split_modified"><a class="viewcode-back" href="../../nimagen.html#nimagen.stats.Stability_tests.train_test_split_modified">[docs]</a>    <span class="nd">@staticmethod</span>
    
    <span class="k">def</span> <span class="nf">train_test_split_modified</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="o">*</span><span class="n">stratify_by_args</span><span class="p">,</span> <span class="n">bins</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                  <span class="n">test_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;[splitting the data based on several stratification]</span>
<span class="sd">    </span>
<span class="sd">        Args:</span>
<span class="sd">            df (Union[pd.DataFrame, np.ndarray], optional): [the data/ dataframe to be split]. Defaults to None.</span>
<span class="sd">            bins (int, optional): [the bins used to separate the continuous data,</span>
<span class="sd">                                        if it is too high, then due to small dataset, there might be error due to not enough data in each class]. Defaults to 4.</span>
<span class="sd">            This works by concatenate multiple stratification criteria together, and then attempt train test split. This is done at each level of stratification. If the stratificatio is not successful, we reduce the bins number, and try again.</span>
<span class="sd">            This is done in succession, so depending on what you want to stratify by, you put it earlier in the list. so GA_vol, PMA_vol will stratify first by GA, and then PMA.</span>
<span class="sd">        Returns:</span>
<span class="sd">            tuple : train and test set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">attempting_train_test_split</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">stratify_by</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">test_size</span><span class="p">,</span><span class="n">random_state</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">stratify_by</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">train</span><span class="p">,</span> <span class="n">test</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">stratification_list</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>  <span class="c1"># remove the last iteration</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;changing bins for </span><span class="si">%d</span><span class="s1"> argument&#39;</span> <span class="o">%</span> <span class="n">idx</span><span class="p">)</span>
    
        <span class="n">input_bins</span> <span class="o">=</span> <span class="n">bins</span>
        <span class="n">stratification_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">stratification</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stratify_by_args</span><span class="p">):</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="n">input_bins</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stratification</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">strat</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">stratification</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">strat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">float</span><span class="p">):</span>
                        <span class="n">strat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">strat</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stratification</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="n">strat</span> <span class="o">=</span> <span class="n">stratification</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stratification</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">float</span><span class="p">):</span>
                        <span class="n">strat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">strat</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">stratification_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">strat</span><span class="p">)</span>
                <span class="n">stratify_by</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">i</span><span class="p">))</span>
                               <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">stratification_list</span><span class="p">)]</span>
                <span class="n">train_test</span> <span class="o">=</span> <span class="n">attempting_train_test_split</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">stratify_by</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span><span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">,</span><span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">train_test</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bins</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">train_test</span></div>
    
    <span class="c1"># @staticmethod</span>
    <span class="c1"># def generate_stratified_fold(df: Union[pd.DataFrame, np.ndarray] = None,</span>
    <span class="c1">#                               *stratify_by_args, </span>
    <span class="c1">#                               bins : int =4,</span>
    <span class="c1">#                               n_splits=3,</span>
    <span class="c1">#                               random_state: int = 42):</span>
    <span class="c1">#     stratified_split = StratifiedKFold(n_splits=n_splits)</span>
    <span class="c1">#     stratification_list = []</span>
    <span class="c1">#     for idx, stratification in enumerate(stratify_by_args):</span>
    <span class="c1">#         bins = input_bins</span>
    <span class="c1">#         while True:</span>
    <span class="c1">#             if isinstance(stratification, str):</span>
    <span class="c1">#                 strat = df.loc[:, stratification].values</span>
    <span class="c1">#                 if isinstance(strat[0], float):</span>
    <span class="c1">#                     strat = pd.cut(strat, bins=bins, labels=False)</span>
    <span class="c1">#             elif isinstance(stratification, np.ndarray):</span>
    <span class="c1">#                 strat = stratification</span>
    <span class="c1">#                 if isinstance(stratification[0], float):</span>
    <span class="c1">#                     strat = pd.cut(strat, bins=bins, labels=False)</span>
    <span class="c1">#             stratification_list.append(strat)</span>
    <span class="c1">#             stratify_by = [&#39;&#39;.join(map(lambda x: str(x), i))</span>
    <span class="c1">#                             for i in zip(*stratification_list)]</span>
    <span class="c1">#             try:</span>
    <span class="c1">#                 train, test = stratified_split.split(df,stratify_by)</span>
    <span class="c1">#                 return train, test</span>
    <span class="c1">#             except ValueError:</span>
    <span class="c1">#                 stratification_list.pop()  # remove the last iteration</span>
    <span class="c1">#                 print(&#39;changing bins for %d argument&#39; % idx)</span>
            
            
        
        
        
<div class="viewcode-block" id="Stability_tests.divide_high_low_risk"><a class="viewcode-back" href="../../nimagen.html#nimagen.stats.Stability_tests.divide_high_low_risk">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">divide_high_low_risk</span><span class="p">(</span><span class="n">y</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">high_perc</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">low_perc</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;[Divide the dataset into top and bottom x%. Here, we take the assumption that top percent is high risk and bottom percent is low risk.</span>
<span class="sd">            While this method maximises the odd ratio for impacts, it raises concerns about the arbitrariness of the quantile used]</span>
<span class="sd">    </span>
<span class="sd">        Args:</span>
<span class="sd">            y (Optional[np.ndarray]): [the raw PRS score]</span>
<span class="sd">            high_perc (float, optional): [higher risk group percentage]. Defaults to 0.1.</span>
<span class="sd">            low_perc (float, optional): [lower risk group percentage]. Defaults to 0.3.</span>
<span class="sd">    </span>
<span class="sd">        Raises:</span>
<span class="sd">            Exception: [If high risk + low risk &gt; total subject, raise exception]</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">            Union[np.ndarray]: [list of indices]</span>
<span class="sd">        &quot;&quot;&quot;</span>
    
        <span class="n">high_risk_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">high_perc</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>
        <span class="n">low_risk_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">low_perc</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">high_risk_number</span><span class="o">+</span><span class="n">low_risk_number</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;The high and low risk selection overlapped&#39;</span><span class="p">)</span>
        <span class="c1"># bottom</span>
        <span class="n">low_risk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">y</span><span class="p">)[:</span><span class="n">low_risk_number</span><span class="p">]</span>
        <span class="c1"># top</span>
        <span class="n">high_risk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">y</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="n">high_risk_number</span><span class="p">]</span>
    
        <span class="k">return</span> <span class="n">high_risk</span><span class="p">,</span> <span class="n">low_risk</span></div>
    
    
<div class="viewcode-block" id="Stability_tests.perform_t_test"><a class="viewcode-back" href="../../nimagen.html#nimagen.stats.Stability_tests.perform_t_test">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">perform_t_test</span><span class="p">(</span><span class="n">group_1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                       <span class="n">group_2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;[perform t-test]</span>
<span class="sd">    </span>
<span class="sd">        Args:</span>
<span class="sd">            group_1 (np.ndarray): [The arrays must have the same shape, except in the dimension corresponding to axis]</span>
<span class="sd">            group_2 (np.ndarray):</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">            List[float]: [stats,pval]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stats</span><span class="p">,</span> <span class="n">pval</span> <span class="o">=</span> <span class="n">ttest_ind</span><span class="p">(</span><span class="n">group_1</span><span class="p">,</span> <span class="n">group_2</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stats</span><span class="p">,</span> <span class="n">pval</span></div></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">NIMAGEN</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, Hai Le.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.4.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>